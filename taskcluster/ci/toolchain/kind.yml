# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
---
loader: taskgraph.loader.transform:loader

kind-dependencies:
    - fetch

transforms:
    - taskgraph.transforms.job:transforms
    - taskgraph.transforms.cached_tasks:transforms
    - taskgraph.transforms.task:transforms

task-defaults:
  worker-type: b-linux
  worker:
    docker-image: {"in-tree": "toolchain-build"}
    max-run-time: 3600
    env: {}
  run:
    using: toolchain-script

tasks:
  # TODO: probably need to make sure that these are all built statically?
  marian:
    description: Marian
    run:
      script: build-marian.sh
      resources:
        - taskcluster/scripts/toolchain/build-marian.sh
        - pipeline/setup/compile-marian.sh
      toolchain-artifact: public/build/marian.tar.zst
    fetches:
      fetch:
        - marian
      #toolchain:
        #- cuda

  fast-align:
    description: fast_align
    run:
      script: build-fast-align.sh
      resources:
        - taskcluster/scripts/toolchain/build-fast-align.sh
      toolchain-artifact: public/build/fast-align.tar.zst
    fetches:
      fetch:
        - fast-align

  preprocess:
    description: preprocess
    run:
      script: build-preprocess.sh
      resources:
        - taskcluster/scripts/toolchain/build-preprocess.sh
      toolchain-artifact: public/build/dedupe
    fetches:
      fetch:
        - preprocess

  extract-lex:
    description: extract-lex
    run:
      script: build-extract-lex.sh
      resources:
        - taskcluster/scripts/toolchain/build-extract-lex.sh
      toolchain-artifact: public/build/extract_lex
    fetches:
      fetch:
        - extract-lex

  pigz:
    description: pigz (parallel gzip)
    run:
      script: build-pigz.sh
      resources:
        - taskcluster/scripts/toolchain/build-pigz.sh
      toolchain-artifact: public/build/pigz.tar.zstd
    fetches:
      fetch:
        - pigz
